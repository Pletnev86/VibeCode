# üì¶ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–µ—Ä–µ–Ω–æ—Å—É –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π OpenRouter

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –∏ –ø–ª–∞—Ç–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ OpenRouter –≤ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ø—Ä–æ–µ–∫—Ç.

## üìã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π

### –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤—Ä—É—á–Ω—É—é):

1. **–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å (–Ω–∞—á–∞–ª–æ):** `deepseek/deepseek-r1:free`
2. **–ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π:**
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: `deepseek/deepseek-r1` (–ø–ª–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è DeepSeek R1)
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: `anthropic/claude-3.5-sonnet` (Claude)
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: `openai/gpt-4o-mini` (GPT-4o mini)

3. **Fallback:** –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (LM Studio / Ollama)

---

## üîß –®–∞–≥ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –º–æ–¥–µ–ª–µ–π

–î–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `server.js` –∏–ª–∏ `config.js`):

```javascript
// ==========================================================
// üîÑ –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π OpenRouter
// ==========================================================
// –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
// 1. –ù–∞—á–∞–ª–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å (FREE_MODEL)
// 2. –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –∫–≤–æ—Ç—ã/–ª–∏–º–∏—Ç–∞ (429, 402) ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å
// 3. –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –≤ —Å–ø–∏—Å–∫–µ
// 4. –ï—Å–ª–∏ –≤—Å–µ –ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
// ==========================================================

// –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
const FREE_MODEL = 'deepseek/deepseek-r1:free';

// –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏:
// 1. deepseek/deepseek-r1 (–ø–ª–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è DeepSeek R1)
// 2. anthropic/claude-3.5-sonnet (Claude –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
// 3. openai/gpt-4o-mini (GPT-4o mini –∫–∞–∫ –±—é–¥–∂–µ—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
// –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
// OPENROUTER_PAID_MODEL_1, OPENROUTER_PAID_MODEL_2, OPENROUTER_PAID_MODEL_3
const PAID_MODELS = [
  process.env.OPENROUTER_PAID_MODEL_1 || 'deepseek/deepseek-r1', // –ü–ª–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è DeepSeek R1 (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
  process.env.OPENROUTER_PAID_MODEL_2 || 'anthropic/claude-3.5-sonnet', // Claude –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)
  process.env.OPENROUTER_PAID_MODEL_3 || 'openai/gpt-4o-mini', // GPT-4o mini –∫–∞–∫ –±—é–¥–∂–µ—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3)
];

// API –∫–ª—é—á OpenRouter (–∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)
const OPENROUTE_KEY = process.env.OPENROUTE_KEY || 
                      process.env.OPENROUTE_KEY_PARALLAX || 
                      process.env.OPENROUTER_API_KEY || 
                      '';
```

---

## üîß –®–∞–≥ 2: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –±–æ—Ç–æ–≤

–î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞:

```javascript
// ==========================================================
// üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ –±–æ—Ç–æ–≤
// ==========================================================
// –•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞:
// - currentMode: —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (API, local, APIFast)
// - preferredMode: –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
// - currentModel: —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å OpenRouter (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–ª–∏ –ø–ª–∞—Ç–Ω–∞—è)
// - paidModelIndex: –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ –≤ —Å–ø–∏—Å–∫–µ PAID_MODELS
// ==========================================================
const botModes = new Map(); // botId -> { currentMode, preferredMode, currentModel, paidModelIndex }

function getBotMode(botId) {
    if (!botModes.has(botId)) {
        botModes.set(botId, { 
            currentMode: 'API', // –∏–ª–∏ –≤–∞—à preferredMode
            preferredMode: 'API',
            currentModel: FREE_MODEL, // –ù–∞—á–∏–Ω–∞–µ–º —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
            paidModelIndex: 0 // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ –≤ —Å–ø–∏—Å–∫–µ
        });
    }
    return botModes.get(botId);
}

function setBotMode(botId, modeObj) {
    botModes.set(botId, { ...getBotMode(botId), ...modeObj });
}
```

---

## üîß –®–∞–≥ 3: –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM

–ó–∞–º–µ–Ω–∏—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter —Å –ª–æ–≥–∏–∫–æ–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:

```javascript
// ==========================================================
// ü§ñ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ LLM (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ OpenRouter)
// ==========================================================
async function queryLlmWithHistory(messages, botId = 'default', recursionLevel = 0) {
  const botState = getBotMode(botId);
  console.log(`‚ÑπÔ∏è [${botId}] –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º: ${botState.currentMode}, –º–æ–¥–µ–ª—å: ${botState.currentModel || FREE_MODEL}`);

  let reply = '';

  try {
    // ======================================================
    // üåê –†–µ–∂–∏–º OpenRouter API
    // ======================================================
    if (botState.currentMode === 'API' || botState.currentMode === 'APIFast') {
      console.log(`üîπ [${botId}] –ò—Å–ø–æ–ª—å–∑—É–µ–º OpenRouter API (–º–æ–¥–µ–ª—å: ${botState.currentModel || FREE_MODEL})`);

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ –≤–∞—à —Ñ–æ—Ä–º–∞—Ç)
      const testMessages = Array.isArray(messages) ? messages : [
        { role: 'system', content: 'You are a helpful assistant.' },
        { role: 'user', content: typeof messages === 'string' ? messages : messages[messages.length - 1]?.content || '' }
      ];

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
      const modelToUse = botState.currentModel || FREE_MODEL;

      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENROUTE_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: modelToUse,
          messages: testMessages,
          max_tokens: 512 // –∏–ª–∏ –≤–∞—à –ª–∏–º–∏—Ç
        }),
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞ –ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å
      if (!response.ok) {
        const errorText = await response.text();
        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch {
          errorData = { error: { message: errorText } };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π –∫–≤–æ—Ç—ã/–ª–∏–º–∏—Ç–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
        const isQuotaError = response.status === 429 || 
                            response.status === 402 || 
                            (errorData.error && (
                              errorData.error.message?.toLowerCase().includes('quota') ||
                              errorData.error.message?.toLowerCase().includes('limit') ||
                              errorData.error.message?.toLowerCase().includes('free tier') ||
                              errorData.error.message?.toLowerCase().includes('insufficient credits')
                            ));

        // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ –∫–≤–æ—Ç—ã –∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–ª–∞—Ç–Ω—É—é
        if (isQuotaError && botState.currentModel === FREE_MODEL && PAID_MODELS.length > 0) {
          const nextPaidModel = PAID_MODELS[botState.paidModelIndex || 0];
          console.warn(`‚ö†Ô∏è [${botId}] –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–≤–æ—Ç–∞/–ª–∏–º–∏—Ç). –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –ø–ª–∞—Ç–Ω—É—é: ${nextPaidModel}`);
          
          setBotMode(botId, { 
            currentModel: nextPaidModel,
            paidModelIndex: botState.paidModelIndex || 0
          });

          // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª—å—é (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è)
          if (recursionLevel < 1) {
            return await queryLlmWithHistory(messages, botId, recursionLevel + 1);
          }
        }

        throw new Error(`API error: ${response.status} - ${errorData.error?.message || errorText}`);
      }

      const data = await response.json();
      reply = data?.choices?.[0]?.message?.content?.trim() || '‚ö†Ô∏è OpenRouter API –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª.';
      console.log(`‚úÖ [${botId}] OpenRouter API –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω (–º–æ–¥–µ–ª—å: ${modelToUse})`);

      // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë –∫–∞–∫ —Ç–µ–∫—É—â—É—é
      if (modelToUse !== FREE_MODEL) {
        setBotMode(botId, { 
          currentMode: botState.preferredMode,
          currentModel: modelToUse
        });
      } else {
        setBotMode(botId, { currentMode: botState.preferredMode });
      }
    }

    // ======================================================
    // üîπ –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (LM Studio / Ollama) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    // ======================================================
    else if (botState.currentMode === 'local') {
      // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏
      // ...
    }

  } catch (err) {
    console.error(`‚ùå [${botId}] –û—à–∏–±–∫–∞ LLM:`, err.message);

    // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ API –∏ –º—ã –µ—â–µ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ –≤—Å–µ –ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏
    if ((botState.currentMode === 'API' || botState.currentMode === 'APIFast') && 
        botState.paidModelIndex !== undefined && 
        botState.paidModelIndex < PAID_MODELS.length - 1 &&
        recursionLevel < PAID_MODELS.length) {
      
      // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å
      const nextIndex = (botState.paidModelIndex || 0) + 1;
      const nextModel = PAID_MODELS[nextIndex];
      
      console.warn(`üîÑ [${botId}] –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å: ${nextModel}`);
      setBotMode(botId, { 
        currentModel: nextModel,
        paidModelIndex: nextIndex
      });
      
      return await queryLlmWithHistory(messages, botId, recursionLevel + 1);
    }

    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏)
    if (botState.currentMode !== 'local' && recursionLevel < PAID_MODELS.length + 1) {
      console.warn(`üîÅ [${botId}] –í—Å–µ –ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (fallback)`);
      setBotMode(botId, { currentMode: 'local' });
      return await queryLlmWithHistory(messages, botId, recursionLevel + 1);
    }

    reply = '‚ö†Ô∏è –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ.';
  }

  return reply;
}
```

---

## üîß –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# API –∫–ª—é—á OpenRouter (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
OPENROUTE_KEY=sk-or-v1-–≤–∞—à-–∫–ª—é—á-–∑–¥–µ—Å—å

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (–µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
OPENROUTER_PAID_MODEL_1=deepseek/deepseek-r1
OPENROUTER_PAID_MODEL_2=anthropic/claude-3.5-sonnet
OPENROUTER_PAID_MODEL_3=openai/gpt-4o-mini
```

---

## üîß –®–∞–≥ 5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```javascript
// –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
const response = await queryLlmWithHistory('–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?', 'user123');

// –° –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
const messages = [
  { role: 'system', content: 'You are a helpful assistant.' },
  { role: 'user', content: '–ü—Ä–∏–≤–µ—Ç' },
  { role: 'assistant', content: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!' },
  { role: 'user', content: '–ö–∞–∫ –¥–µ–ª–∞?' }
];
const response = await queryLlmWithHistory(messages, 'user123');
```

---

## üìä –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å (–Ω–∞—á–∞–ª–æ)         ‚îÇ
‚îÇ  deepseek/deepseek-r1:free          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº (–æ—à–∏–±–∫–∞ –∫–≤–æ—Ç—ã 429/402)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å #1                  ‚îÇ
‚îÇ  deepseek/deepseek-r1               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å #2                  ‚îÇ
‚îÇ  anthropic/claude-3.5-sonnet        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å #3                  ‚îÇ
‚îÇ  openai/gpt-4o-mini                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº (–≤—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (fallback)       ‚îÇ
‚îÇ  LM Studio / Ollama                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:
   ```
   ‚ÑπÔ∏è [botId] –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º: API, –º–æ–¥–µ–ª—å: deepseek/deepseek-r1:free
   ‚ö†Ô∏è [botId] –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–≤–æ—Ç–∞/–ª–∏–º–∏—Ç). –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –ø–ª–∞—Ç–Ω—É—é: deepseek/deepseek-r1
   ‚úÖ [botId] OpenRouter API –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω (–º–æ–¥–µ–ª—å: deepseek/deepseek-r1)
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–æ–≤**:
   ```javascript
   const botState = getBotMode('user123');
   console.log('–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:', botState.currentModel);
   console.log('–ò–Ω–¥–µ–∫—Å –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏:', botState.paidModelIndex);
   ```

---

## üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∫–≤–æ—Ç—ã

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—à–∏–±–∫–∏ –∫–≤–æ—Ç—ã –ø–æ:
- **HTTP —Å—Ç–∞—Ç—É—Å–∞–º:** 429 (Too Many Requests), 402 (Payment Required)
- **–°–æ–æ–±—â–µ–Ω–∏—è–º –æ–± –æ—à–∏–±–∫–∞—Ö:** —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–ª–æ–≤–∞ "quota", "limit", "free tier", "insufficient credits"

---

## üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –º–æ–¥–µ–ª–µ–π

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
OPENROUTER_PAID_MODEL_1=deepseek/deepseek-r1
OPENROUTER_PAID_MODEL_2=anthropic/claude-3.5-sonnet
OPENROUTER_PAID_MODEL_3=openai/gpt-4o-mini
```

### –°–ø–æ—Å–æ–± 2: –ü—Ä—è–º–æ –≤ –∫–æ–¥–µ

```javascript
const PAID_MODELS = [
  'deepseek/deepseek-r1',           // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1
  'anthropic/claude-3.5-sonnet',     // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2
  'openai/gpt-4o-mini',              // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3
];
```

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ö–∞–∂–¥—ã–π –±–æ—Ç –∏–º–µ–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö
2. **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏** - –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—É—â–∞—è –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∫–≤–æ—Ç—ã/–ª–∏–º–∏—Ç–∞
4. **–ü—Ä–∏ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–∫–∞—Ö** (—Å–µ—Ç—å, —Ç–∞–π–º–∞—É—Ç) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
5. **–ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —Ä–∞–∑–º–µ—Ä–æ–º —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π

---

## üöÄ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –∏ –ø–ª–∞—Ç–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ OpenRouter –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –∫–≤–æ—Ç—ã.

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [OpenRouter API Documentation](https://openrouter.ai/docs)
- [–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π OpenRouter](https://openrouter.ai/models)
- [LM Studio –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π](https://lmstudio.ai/)

---

**–í–µ—Ä—Å–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-27  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** Node.js 16+, OpenRouter API

